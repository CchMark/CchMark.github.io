{{/* 
  優化圖片載入的 shortcode - 確保圖片不變形
  使用方式: {{< img-lazy src="images/example.jpg" alt="描述文字" class="可選的CSS類別" width="寬度" height="高度" >}}
*/}}

{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default "圖片" }}
{{ $class := .Get "class" | default "responsive-img" }}
{{ $width := .Get "width" }}
{{ $height := .Get "height" }}
{{ $aspectRatio := .Get "aspect-ratio" | default "auto" }}

{{/* 嘗試處理圖片資源 */}}
{{ $image := "" }}
{{ if (fileExists (printf "static/%s" $src)) }}
  {{ $image = resources.Get $src }}
{{ end }}

{{ if $image }}
  {{/* 如果找到圖片資源，進行優化處理 */}}
  {{ $webp := $image.Resize "800x webp q85" }}
  {{ $jpeg := $image.Resize "800x jpeg q85" }}
  
  <div class="img-container {{ $class }}" {{ if ne $aspectRatio "auto" }}style="aspect-ratio: {{ $aspectRatio }};"{{ end }}>
    <picture>
      <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
      <img src="{{ $jpeg.RelPermalink }}" 
           alt="{{ $alt }}" 
           {{ with $width }}width="{{ . }}"{{ end }}
           {{ with $height }}height="{{ . }}"{{ end }}
           class="responsive-img"
           loading="lazy"
           decoding="async">
    </picture>
  </div>
{{ else }}
  {{/* 如果找不到圖片資源，使用原始路徑 */}}
  <div class="img-container {{ $class }}" {{ if ne $aspectRatio "auto" }}style="aspect-ratio: {{ $aspectRatio }};"{{ end }}>
    <img src="{{ $src | relURL }}" 
         alt="{{ $alt }}" 
         class="responsive-img"
         {{ with $width }}width="{{ . }}"{{ end }}
         {{ with $height }}height="{{ . }}"{{ end }}
         loading="lazy"
         decoding="async">
  </div>
{{ end }}
