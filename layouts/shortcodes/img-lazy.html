{{/* 
  優化圖片載入的 shortcode - 確保圖片不變形
  使用方式: {{< img-lazy src="images/example.jpg" alt="描述文字" class="可選的CSS類別" width="寬度" height="高度" >}}
*/}}

{{ $src := .Get "src" }}
{{ $alt := .Get "alt" | default "圖片" }}
{{ $class := .Get "class" | default "responsive-img" }}
{{ $width := .Get "width" }}
{{ $height := .Get "height" }}
{{ $aspectRatio := .Get "aspect-ratio" | default "auto" }}

{{/* 嘗試處理圖片資源 */}}
{{ $image := "" }}
{{ if (fileExists (printf "static/%s" $src)) }}
  {{ $image = resources.Get $src }}
{{ end }}

{{ if $image }}
  {{/* 如果找到圖片資源，進行優化處理 */}}
  {{ $webp := $image.Resize "800x webp q85" }}
  {{ $jpeg := $image.Resize "800x jpeg q85" }}
  
  <picture class="{{ $class }}" style="aspect-ratio: {{ $aspectRatio }}; max-width: 100%; height: auto;">
    <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
    <img src="{{ $jpeg.RelPermalink }}" 
         alt="{{ $alt }}" 
         {{ with $width }}width="{{ . }}"{{ end }}
         {{ with $height }}height="{{ . }}"{{ end }}
         style="width: 100%; height: 100%; object-fit: contain; object-position: center;"
         loading="lazy"
         decoding="async">
  </picture>
{{ else }}
  {{/* 如果找不到圖片資源，使用原始路徑 */}}
  <img src="{{ $src | relURL }}" 
       alt="{{ $alt }}" 
       class="{{ $class }}"
       {{ with $width }}width="{{ . }}"{{ end }}
       {{ with $height }}height="{{ . }}"{{ end }}
       style="max-width: 100%; height: auto; aspect-ratio: {{ $aspectRatio }}; object-fit: contain;"
       loading="lazy"
       decoding="async">
{{ end }}
